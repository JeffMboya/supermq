
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>users: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/absmach/magistrala/users/service.go (98.1%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">no coverage</span>
				<span class="cov1">low coverage</span>
				<span class="cov2">*</span>
				<span class="cov3">*</span>
				<span class="cov4">*</span>
				<span class="cov5">*</span>
				<span class="cov6">*</span>
				<span class="cov7">*</span>
				<span class="cov8">*</span>
				<span class="cov9">*</span>
				<span class="cov10">high coverage</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">// Copyright (c) Abstract Machines
// SPDX-License-Identifier: Apache-2.0

package users

import (
        "context"
        "fmt"
        "time"

        "github.com/absmach/magistrala"
        "github.com/absmach/magistrala/auth"
        mgclients "github.com/absmach/magistrala/pkg/clients"
        "github.com/absmach/magistrala/pkg/errors"
        repoerr "github.com/absmach/magistrala/pkg/errors/repository"
        svcerr "github.com/absmach/magistrala/pkg/errors/service"
        mgoauth2 "github.com/absmach/magistrala/pkg/oauth2"
        "github.com/absmach/magistrala/users/postgres"
        "golang.org/x/sync/errgroup"
)

var (
        errIssueToken            = errors.New("failed to issue token")
        errUserNotSignedUp       = errors.New("user not signed up")
        errFailedPermissionsList = errors.New("failed to list permissions")
        errRecoveryToken         = errors.New("failed to generate password recovery token")
        errLoginDisableUser      = errors.New("failed to login in disabled user")
)

type service struct {
        clients      postgres.Repository
        idProvider   magistrala.IDProvider
        auth         magistrala.AuthServiceClient
        hasher       Hasher
        email        Emailer
        selfRegister bool
        isAdmin      bool
}

// NewService returns a new Users service implementation.
func NewService(crepo postgres.Repository, authClient magistrala.AuthServiceClient, emailer Emailer, hasher Hasher, idp magistrala.IDProvider, selfRegister bool) Service <span class="cov6" title="18">{
        return service{
                clients:      crepo,
                auth:         authClient,
                hasher:       hasher,
                email:        emailer,
                idProvider:   idp,
                selfRegister: selfRegister,
        }
}</span>

func (svc service) RegisterClient(ctx context.Context, token string, cli mgclients.Client) (rc mgclients.Client, err error) <span class="cov6" title="20">{
        if !svc.selfRegister </span><span class="cov3" title="4">{
                userID, err := svc.Identify(ctx, token)
                if err != nil </span><span class="cov1" title="1">{
                        return mgclients.Client{}, err
                }</span>
                <span class="cov3" title="3">if _, err := svc.checkSuperAdmin(ctx, userID); err != nil </span><span class="cov2" title="2">{
                        return mgclients.Client{}, err
                }</span>
        }

        <span class="cov6" title="17">clientID, err := svc.idProvider.ID()
        if err != nil </span><span class="cov0" title="0">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov6" title="17">if cli.Credentials.Secret != "" </span><span class="cov6" title="14">{
                hash, err := svc.hasher.Hash(cli.Credentials.Secret)
                if err != nil </span><span class="cov1" title="1">{
                        return mgclients.Client{}, errors.Wrap(svcerr.ErrMalformedEntity, err)
                }</span>
                <span class="cov6" title="13">cli.Credentials.Secret = hash</span>
        }

        <span class="cov6" title="16">if cli.Status != mgclients.DisabledStatus &amp;&amp; cli.Status != mgclients.EnabledStatus </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrMalformedEntity, svcerr.ErrInvalidStatus)
        }</span>
        <span class="cov6" title="15">if cli.Role != mgclients.UserRole &amp;&amp; cli.Role != mgclients.AdminRole </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrMalformedEntity, svcerr.ErrInvalidRole)
        }</span>
        <span class="cov6" title="14">cli.ID = clientID
        cli.CreatedAt = time.Now()

        if err := svc.addClientPolicy(ctx, cli.ID, cli.Role); err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov5" title="12">defer func() </span><span class="cov5" title="12">{
                if err != nil </span><span class="cov4" title="5">{
                        if errRollback := svc.addClientPolicyRollback(ctx, cli.ID, cli.Role); errRollback != nil </span><span class="cov2" title="2">{
                                err = errors.Wrap(errors.Wrap(repoerr.ErrRollbackTx, errRollback), err)
                        }</span>
                }
        }()
        <span class="cov5" title="12">client, err := svc.clients.Save(ctx, cli)
        if err != nil </span><span class="cov4" title="5">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrCreateEntity, err)
        }</span>
        <span class="cov4" title="7">return client, nil</span>
}

func (svc service) IssueToken(ctx context.Context, identity, secret, domainID string) (*magistrala.Token, error) <span class="cov5" title="11">{
        dbUser, err := svc.clients.RetrieveByIdentity(ctx, identity)
        if err != nil </span><span class="cov2" title="2">{
                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrAuthentication, err)
        }</span>
        <span class="cov5" title="9">if err := svc.hasher.Compare(secret, dbUser.Credentials.Secret); err != nil </span><span class="cov2" title="2">{
                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrLogin, err)
        }</span>

        <span class="cov4" title="7">var d string
        if domainID != "" </span><span class="cov1" title="1">{
                d = domainID
        }</span>

        <span class="cov4" title="7">token, err := svc.auth.Issue(ctx, &amp;magistrala.IssueReq{UserId: dbUser.ID, DomainId: &amp;d, Type: uint32(auth.AccessKey)})
        if err != nil </span><span class="cov2" title="2">{
                return &amp;magistrala.Token{}, errors.Wrap(errIssueToken, err)
        }</span>

        <span class="cov4" title="5">return token, err</span>
}

func (svc service) RefreshToken(ctx context.Context, refreshToken, domainID string) (*magistrala.Token, error) <span class="cov4" title="7">{
        var d string
        if domainID != "" </span><span class="cov4" title="5">{
                d = domainID
        }</span>

        <span class="cov4" title="7">tokenUserID, err := svc.Identify(ctx, refreshToken)
        if err != nil </span><span class="cov1" title="1">{
                return &amp;magistrala.Token{}, err
        }</span>

        <span class="cov4" title="6">dbUser, err := svc.clients.RetrieveByID(ctx, tokenUserID)
        if err != nil </span><span class="cov1" title="1">{
                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrAuthentication, err)
        }</span>
        <span class="cov4" title="5">if dbUser.Status == mgclients.DisabledStatus </span><span class="cov1" title="1">{
                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrAuthentication, errLoginDisableUser)
        }</span>

        <span class="cov3" title="4">return svc.auth.Refresh(ctx, &amp;magistrala.RefreshReq{RefreshToken: refreshToken, DomainId: &amp;d})</span>
}

func (svc service) ViewClient(ctx context.Context, token, id string) (mgclients.Client, error) <span class="cov4" title="7">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov3" title="3">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov3" title="4">client, err := svc.clients.RetrieveByID(ctx, id)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>

        <span class="cov3" title="3">if tokenUserID != id </span><span class="cov2" title="2">{
                if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov1" title="1">{
                        return mgclients.Client{Name: client.Name, ID: client.ID}, nil
                }</span>
        }

        <span class="cov2" title="2">client.Credentials.Secret = ""

        return client, nil</span>
}

func (svc service) ViewProfile(ctx context.Context, token string) (mgclients.Client, error) <span class="cov3" title="3">{
        id, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov2" title="2">client, err := svc.clients.RetrieveByID(ctx, id)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>
        <span class="cov1" title="1">client.Credentials.Secret = ""

        return client, nil</span>
}

func (svc service) ListClients(ctx context.Context, token string, pm mgclients.Page) (mgclients.ClientsPage, error) <span class="cov6" title="13">{
        userID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.ClientsPage{}, err
        }</span>
        <span class="cov5" title="12">if _, err := svc.checkSuperAdmin(ctx, userID); err == nil </span><span class="cov5" title="8">{
                pg, err := svc.clients.RetrieveAll(ctx, pm)
                if err != nil </span><span class="cov1" title="1">{
                        return mgclients.ClientsPage{}, errors.Wrap(svcerr.ErrViewEntity, err)
                }</span>
                <span class="cov4" title="7">return pg, err</span>
        }

        <span class="cov3" title="4">p := mgclients.Page{
                Status:   mgclients.EnabledStatus,
                Offset:   pm.Offset,
                Limit:    pm.Limit,
                Name:     pm.Name,
                Identity: pm.Identity,
                Role:     mgclients.UserRole,
        }
        pg, err := svc.clients.RetrieveAll(ctx, p)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.ClientsPage{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>

        <span class="cov3" title="3">for i, c := range pg.Clients </span><span class="cov1" title="1">{
                pg.Clients[i] = mgclients.Client{ID: c.ID, Name: c.Name}
        }</span>

        <span class="cov3" title="3">return pg, nil</span>
}

func (svc service) UpdateClient(ctx context.Context, token string, cli mgclients.Client) (mgclients.Client, error) <span class="cov5" title="10">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov5" title="8">if tokenUserID != cli.ID </span><span class="cov4" title="5">{
                if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov2" title="2">{
                        return mgclients.Client{}, err
                }</span>
        }

        <span class="cov4" title="6">client := mgclients.Client{
                ID:        cli.ID,
                Name:      cli.Name,
                Metadata:  cli.Metadata,
                UpdatedAt: time.Now(),
                UpdatedBy: tokenUserID,
        }

        client, err = svc.clients.Update(ctx, client)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)
        }</span>
        <span class="cov3" title="4">return client, nil</span>
}

func (svc service) UpdateClientTags(ctx context.Context, token string, cli mgclients.Client) (mgclients.Client, error) <span class="cov5" title="8">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov4" title="6">if tokenUserID != cli.ID </span><span class="cov3" title="4">{
                if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov2" title="2">{
                        return mgclients.Client{}, err
                }</span>
        }

        <span class="cov3" title="4">client := mgclients.Client{
                ID:        cli.ID,
                Tags:      cli.Tags,
                UpdatedAt: time.Now(),
                UpdatedBy: tokenUserID,
        }
        client, err = svc.clients.UpdateTags(ctx, client)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)
        }</span>

        <span class="cov2" title="2">return client, nil</span>
}

func (svc service) UpdateClientIdentity(ctx context.Context, token, clientID, identity string) (mgclients.Client, error) <span class="cov5" title="8">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov4" title="6">if tokenUserID != clientID </span><span class="cov3" title="4">{
                if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov2" title="2">{
                        return mgclients.Client{}, err
                }</span>
        }

        <span class="cov3" title="4">cli := mgclients.Client{
                ID: clientID,
                Credentials: mgclients.Credentials{
                        Identity: identity,
                },
                UpdatedAt: time.Now(),
                UpdatedBy: tokenUserID,
        }
        cli, err = svc.clients.UpdateIdentity(ctx, cli)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)
        }</span>
        <span class="cov2" title="2">return cli, nil</span>
}

func (svc service) GenerateResetToken(ctx context.Context, email, host string) error <span class="cov3" title="3">{
        client, err := svc.clients.RetrieveByIdentity(ctx, email)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>
        <span class="cov2" title="2">issueReq := &amp;magistrala.IssueReq{
                UserId: client.ID,
                Type:   uint32(auth.RecoveryKey),
        }
        token, err := svc.auth.Issue(ctx, issueReq)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(errRecoveryToken, err)
        }</span>

        <span class="cov1" title="1">return svc.SendPasswordReset(ctx, host, email, client.Name, token.AccessToken)</span>
}

func (svc service) ResetSecret(ctx context.Context, resetToken, secret string) error <span class="cov4" title="6">{
        id, err := svc.Identify(ctx, resetToken)
        if err != nil </span><span class="cov1" title="1">{
                return err
        }</span>
        <span class="cov4" title="5">c, err := svc.clients.RetrieveByID(ctx, id)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>

        <span class="cov3" title="4">secret, err = svc.hasher.Hash(secret)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrMalformedEntity, err)
        }</span>
        <span class="cov3" title="3">c = mgclients.Client{
                ID: c.ID,
                Credentials: mgclients.Credentials{
                        Identity: c.Credentials.Identity,
                        Secret:   secret,
                },
                UpdatedAt: time.Now(),
                UpdatedBy: id,
        }
        if _, err := svc.clients.UpdateSecret(ctx, c); err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrAuthorization, err)
        }</span>
        <span class="cov2" title="2">return nil</span>
}

func (svc service) UpdateClientSecret(ctx context.Context, token, oldSecret, newSecret string) (mgclients.Client, error) <span class="cov4" title="7">{
        id, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov4" title="6">dbClient, err := svc.clients.RetrieveByID(ctx, id)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>
        <span class="cov4" title="5">if _, err := svc.IssueToken(ctx, dbClient.Credentials.Identity, oldSecret, ""); err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov3" title="3">newSecret, err = svc.hasher.Hash(newSecret)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrMalformedEntity, err)
        }</span>
        <span class="cov2" title="2">dbClient.Credentials.Secret = newSecret
        dbClient.UpdatedAt = time.Now()
        dbClient.UpdatedBy = id

        dbClient, err = svc.clients.UpdateSecret(ctx, dbClient)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)
        }</span>

        <span class="cov1" title="1">return dbClient, nil</span>
}

func (svc service) SendPasswordReset(_ context.Context, host, email, user, token string) error <span class="cov1" title="1">{
        to := []string{email}
        return svc.email.SendPasswordReset(to, host, user, token)
}</span>

func (svc service) UpdateClientRole(ctx context.Context, token string, cli mgclients.Client) (mgclients.Client, error) <span class="cov6" title="13">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov5" title="11">if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov3" title="3">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov5" title="8">client := mgclients.Client{
                ID:        cli.ID,
                Role:      cli.Role,
                UpdatedAt: time.Now(),
                UpdatedBy: tokenUserID,
        }

        if svc.isAdmin </span><span class="cov0" title="0">{
                if _, err := svc.authorize(ctx, auth.UserType, auth.UsersKind, client.ID, auth.MembershipPermission, auth.PlatformType, auth.MagistralaObject); err != nil </span><span class="cov0" title="0">{
                        return mgclients.Client{}, errors.Wrap(svcerr.ErrMalformedEntity, err)
                }</span>
        }

        <span class="cov5" title="8">if err := svc.updateClientPolicy(ctx, cli.ID, cli.Role); err != nil </span><span class="cov3" title="4">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov3" title="4">client, err = svc.clients.UpdateRole(ctx, client)
        if err != nil </span><span class="cov2" title="2">{
                // If failed to update role in DB, then revert back to platform admin policy in spicedb
                if errRollback := svc.updateClientPolicy(ctx, cli.ID, mgclients.UserRole); errRollback != nil </span><span class="cov1" title="1">{
                        return mgclients.Client{}, errors.Wrap(errRollback, err)
                }</span>
                <span class="cov1" title="1">return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)</span>
        }
        <span class="cov2" title="2">return client, nil</span>
}

func (svc service) EnableClient(ctx context.Context, token, id string) (mgclients.Client, error) <span class="cov4" title="7">{
        client := mgclients.Client{
                ID:        id,
                UpdatedAt: time.Now(),
                Status:    mgclients.EnabledStatus,
        }
        client, err := svc.changeClientStatus(ctx, token, client)
        if err != nil </span><span class="cov4" title="6">{
                return mgclients.Client{}, errors.Wrap(mgclients.ErrEnableClient, err)
        }</span>

        <span class="cov1" title="1">return client, nil</span>
}

func (svc service) DisableClient(ctx context.Context, token, id string) (mgclients.Client, error) <span class="cov4" title="7">{
        client := mgclients.Client{
                ID:        id,
                UpdatedAt: time.Now(),
                Status:    mgclients.DisabledStatus,
        }
        client, err := svc.changeClientStatus(ctx, token, client)
        if err != nil </span><span class="cov4" title="6">{
                return mgclients.Client{}, err
        }</span>

        <span class="cov1" title="1">return client, nil</span>
}

func (svc service) changeClientStatus(ctx context.Context, token string, client mgclients.Client) (mgclients.Client, error) <span class="cov6" title="14">{
        tokenUserID, err := svc.Identify(ctx, token)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov5" title="12">if _, err := svc.checkSuperAdmin(ctx, tokenUserID); err != nil </span><span class="cov3" title="4">{
                return mgclients.Client{}, err
        }</span>
        <span class="cov5" title="8">dbClient, err := svc.clients.RetrieveByID(ctx, client.ID)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>
        <span class="cov4" title="6">if dbClient.Status == client.Status </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.ErrStatusAlreadyAssigned
        }</span>
        <span class="cov3" title="4">client.UpdatedBy = tokenUserID

        client, err = svc.clients.ChangeStatus(ctx, client)
        if err != nil </span><span class="cov2" title="2">{
                return mgclients.Client{}, errors.Wrap(svcerr.ErrUpdateEntity, err)
        }</span>
        <span class="cov2" title="2">return client, nil</span>
}

func (svc service) ListMembers(ctx context.Context, token, objectKind, objectID string, pm mgclients.Page) (mgclients.MembersPage, error) <span class="cov6" title="13">{
        res, err := svc.identify(ctx, token)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.MembersPage{}, err
        }</span>
        <span class="cov5" title="12">var objectType string
        var authzPerm string
        switch objectKind </span>{
        case auth.ThingsKind:<span class="cov4" title="7">
                objectType = auth.ThingType
                authzPerm = pm.Permission</span>
        case auth.DomainsKind:<span class="cov3" title="3">
                objectType = auth.DomainType
                authzPerm = auth.SwitchToPermission(pm.Permission)</span>
        case auth.GroupsKind:<span class="cov2" title="2">
                fallthrough</span>
        default:<span class="cov2" title="2">
                objectType = auth.GroupType
                authzPerm = auth.SwitchToPermission(pm.Permission)</span>
        }

        <span class="cov5" title="12">if _, err := svc.authorize(ctx, auth.UserType, auth.TokenKind, token, authzPerm, objectType, objectID); err != nil </span><span class="cov2" title="2">{
                return mgclients.MembersPage{}, errors.Wrap(svcerr.ErrAuthorization, err)
        }</span>
        <span class="cov5" title="10">duids, err := svc.auth.ListAllSubjects(ctx, &amp;magistrala.ListSubjectsReq{
                SubjectType: auth.UserType,
                Permission:  pm.Permission,
                Object:      objectID,
                ObjectType:  objectType,
        })
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.MembersPage{}, errors.Wrap(svcerr.ErrNotFound, err)
        }</span>
        <span class="cov5" title="9">if len(duids.Policies) == 0 </span><span class="cov3" title="3">{
                return mgclients.MembersPage{
                        Page: mgclients.Page{Total: 0, Offset: pm.Offset, Limit: pm.Limit},
                }, nil
        }</span>

        <span class="cov4" title="6">var userIDs []string

        for _, domainUserID := range duids.Policies </span><span class="cov4" title="6">{
                _, userID := auth.DecodeDomainUserID(domainUserID)
                userIDs = append(userIDs, userID)
        }</span>
        <span class="cov4" title="6">pm.IDs = userIDs

        cp, err := svc.clients.RetrieveAll(ctx, pm)
        if err != nil </span><span class="cov1" title="1">{
                return mgclients.MembersPage{}, errors.Wrap(svcerr.ErrViewEntity, err)
        }</span>

        <span class="cov4" title="5">for i, c := range cp.Clients </span><span class="cov4" title="5">{
                cp.Clients[i] = mgclients.Client{ID: c.ID, Name: c.Name}
        }</span>

        <span class="cov4" title="5">if pm.ListPerms &amp;&amp; len(cp.Clients) &gt; 0 </span><span class="cov2" title="2">{
                g, ctx := errgroup.WithContext(ctx)

                for i := range cp.Clients </span><span class="cov2" title="2">{
                        // Copying loop variable "i" to avoid "loop variable captured by func literal"
                        iter := i
                        g.Go(func() error </span><span class="cov2" title="2">{
                                return svc.retrieveObjectUsersPermissions(ctx, res.GetDomainId(), objectType, objectID, &amp;cp.Clients[iter])
                        }</span>)
                }

                <span class="cov2" title="2">if err := g.Wait(); err != nil </span><span class="cov1" title="1">{
                        return mgclients.MembersPage{}, err
                }</span>
        }

        <span class="cov3" title="4">return mgclients.MembersPage{
                Page:    cp.Page,
                Members: cp.Clients,
        }, nil</span>
}

func (svc service) retrieveObjectUsersPermissions(ctx context.Context, domainID, objectType, objectID string, client *mgclients.Client) error <span class="cov2" title="2">{
        userID := auth.EncodeDomainUserID(domainID, client.ID)
        permissions, err := svc.listObjectUserPermission(ctx, userID, objectType, objectID)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrAuthorization, err)
        }</span>
        <span class="cov1" title="1">client.Permissions = permissions
        return nil</span>
}

func (svc service) listObjectUserPermission(ctx context.Context, userID, objectType, objectID string) ([]string, error) <span class="cov2" title="2">{
        lp, err := svc.auth.ListPermissions(ctx, &amp;magistrala.ListPermissionsReq{
                SubjectType: auth.UserType,
                Subject:     userID,
                Object:      objectID,
                ObjectType:  objectType,
        })
        if err != nil </span><span class="cov1" title="1">{
                return []string{}, errors.Wrap(errFailedPermissionsList, err)
        }</span>
        <span class="cov1" title="1">return lp.GetPermissions(), nil</span>
}

func (svc *service) checkSuperAdmin(ctx context.Context, adminID string) (bool, error) <span class="cov8" title="53">{
        if _, err := svc.authorize(ctx, auth.UserType, auth.UsersKind, adminID, auth.AdminPermission, auth.PlatformType, auth.MagistralaObject); err != nil </span><span class="cov6" title="20">{
                if err := svc.clients.CheckSuperAdmin(ctx, adminID); err != nil </span><span class="cov5" title="9">{
                        return false, errors.Wrap(svcerr.ErrAuthorization, err)
                }</span>
                <span class="cov5" title="11">return false, errors.Wrap(svcerr.ErrAuthorization, err)</span>
        }

        <span class="cov7" title="33">return true, nil</span>
}

func (svc service) identify(ctx context.Context, token string) (*magistrala.IdentityRes, error) <span class="cov6" title="13">{
        res, err := svc.auth.Identify(ctx, &amp;magistrala.IdentityReq{Token: token})
        if err != nil </span><span class="cov1" title="1">{
                return &amp;magistrala.IdentityRes{}, errors.Wrap(svcerr.ErrAuthentication, err)
        }</span>
        <span class="cov5" title="12">return res, nil</span>
}

func (svc *service) authorize(ctx context.Context, subjType, subjKind, subj, perm, objType, obj string) (string, error) <span class="cov9" title="65">{
        req := &amp;magistrala.AuthorizeReq{
                SubjectType: subjType,
                SubjectKind: subjKind,
                Subject:     subj,
                Permission:  perm,
                ObjectType:  objType,
                Object:      obj,
        }
        res, err := svc.auth.Authorize(ctx, req)
        if err != nil </span><span class="cov1" title="1">{
                return "", errors.Wrap(svcerr.ErrAuthorization, err)
        }</span>

        <span class="cov9" title="64">if !res.GetAuthorized() </span><span class="cov6" title="21">{
                return "", svcerr.ErrAuthorization
        }</span>
        <span class="cov8" title="43">return res.GetId(), nil</span>
}

func (svc service) OAuthCallback(ctx context.Context, state mgoauth2.State, client mgclients.Client) (*magistrala.Token, error) <span class="cov3" title="4">{
        switch state </span>{
        case mgoauth2.SignIn:<span class="cov2" title="2">
                rclient, err := svc.clients.RetrieveByIdentity(ctx, client.Credentials.Identity)
                if err != nil </span><span class="cov1" title="1">{
                        if errors.Contains(err, repoerr.ErrNotFound) </span><span class="cov1" title="1">{
                                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrNotFound, errUserNotSignedUp)
                        }</span>
                        <span class="cov0" title="0">return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrViewEntity, err)</span>
                }
                <span class="cov1" title="1">claims := &amp;magistrala.IssueReq{
                        UserId: rclient.ID,
                        Type:   uint32(auth.AccessKey),
                }
                return svc.auth.Issue(ctx, claims)</span>
        case mgoauth2.SignUp:<span class="cov2" title="2">
                rclient, err := svc.RegisterClient(ctx, "", client)
                if err != nil </span><span class="cov1" title="1">{
                        if errors.Contains(err, repoerr.ErrConflict) </span><span class="cov1" title="1">{
                                return &amp;magistrala.Token{}, errors.Wrap(svcerr.ErrConflict, errors.New("user already exists"))
                        }</span>
                        <span class="cov0" title="0">return &amp;magistrala.Token{}, err</span>
                }
                <span class="cov1" title="1">claims := &amp;magistrala.IssueReq{
                        UserId: rclient.ID,
                        Type:   uint32(auth.AccessKey),
                }
                return svc.auth.Issue(ctx, claims)</span>
        default:<span class="cov0" title="0">
                return &amp;magistrala.Token{}, fmt.Errorf("unknown state %s", state)</span>
        }
}

func (svc service) Identify(ctx context.Context, token string) (string, error) <span class="cov10" title="100">{
        user, err := svc.auth.Identify(ctx, &amp;magistrala.IdentityReq{Token: token})
        if err != nil </span><span class="cov6" title="19">{
                return "", errors.Wrap(svcerr.ErrAuthentication, err)
        }</span>
        <span class="cov9" title="81">return user.GetUserId(), nil</span>
}

func (svc service) addClientPolicy(ctx context.Context, userID string, role mgclients.Role) error <span class="cov6" title="14">{
        var policies magistrala.AddPoliciesReq

        policies.AddPoliciesReq = append(policies.AddPoliciesReq, &amp;magistrala.AddPolicyReq{
                SubjectType: auth.UserType,
                Subject:     userID,
                Relation:    auth.MemberRelation,
                ObjectType:  auth.PlatformType,
                Object:      auth.MagistralaObject,
        })

        if role == mgclients.AdminRole </span><span class="cov3" title="4">{
                policies.AddPoliciesReq = append(policies.AddPoliciesReq, &amp;magistrala.AddPolicyReq{
                        SubjectType: auth.UserType,
                        Subject:     userID,
                        Relation:    auth.AdministratorRelation,
                        ObjectType:  auth.PlatformType,
                        Object:      auth.MagistralaObject,
                })
        }</span>
        <span class="cov6" title="14">resp, err := svc.auth.AddPolicies(ctx, &amp;policies)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrAddPolicies, err)
        }</span>
        <span class="cov6" title="13">if !resp.Added </span><span class="cov1" title="1">{
                return svcerr.ErrAuthorization
        }</span>
        <span class="cov5" title="12">return nil</span>
}

func (svc service) addClientPolicyRollback(ctx context.Context, userID string, role mgclients.Role) error <span class="cov4" title="5">{
        var policies magistrala.DeletePoliciesReq

        policies.DeletePoliciesReq = append(policies.DeletePoliciesReq, &amp;magistrala.DeletePolicyReq{
                SubjectType: auth.UserType,
                Subject:     userID,
                Relation:    auth.MemberRelation,
                ObjectType:  auth.PlatformType,
                Object:      auth.MagistralaObject,
        })

        if role == mgclients.AdminRole </span><span class="cov2" title="2">{
                policies.DeletePoliciesReq = append(policies.DeletePoliciesReq, &amp;magistrala.DeletePolicyReq{
                        SubjectType: auth.UserType,
                        Subject:     userID,
                        Relation:    auth.AdministratorRelation,
                        ObjectType:  auth.PlatformType,
                        Object:      auth.MagistralaObject,
                })
        }</span>
        <span class="cov4" title="5">resp, err := svc.auth.DeletePolicies(ctx, &amp;policies)
        if err != nil </span><span class="cov1" title="1">{
                return errors.Wrap(svcerr.ErrDeletePolicies, err)
        }</span>
        <span class="cov3" title="4">if !resp.Deleted </span><span class="cov1" title="1">{
                return svcerr.ErrAuthorization
        }</span>
        <span class="cov3" title="3">return nil</span>
}

func (svc service) updateClientPolicy(ctx context.Context, userID string, role mgclients.Role) error <span class="cov5" title="10">{
        switch role </span>{
        case mgclients.AdminRole:<span class="cov4" title="5">
                resp, err := svc.auth.AddPolicy(ctx, &amp;magistrala.AddPolicyReq{
                        SubjectType: auth.UserType,
                        Subject:     userID,
                        Relation:    auth.AdministratorRelation,
                        ObjectType:  auth.PlatformType,
                        Object:      auth.MagistralaObject,
                })
                if err != nil </span><span class="cov1" title="1">{
                        return errors.Wrap(svcerr.ErrAddPolicies, err)
                }</span>
                <span class="cov3" title="4">if !resp.Added </span><span class="cov1" title="1">{
                        return svcerr.ErrAuthorization
                }</span>
                <span class="cov3" title="3">return nil</span>
        case mgclients.UserRole:<span class="cov4" title="5">
                fallthrough</span>
        default:<span class="cov4" title="5">
                resp, err := svc.auth.DeletePolicy(ctx, &amp;magistrala.DeletePolicyReq{
                        SubjectType: auth.UserType,
                        Subject:     userID,
                        Relation:    auth.AdministratorRelation,
                        ObjectType:  auth.PlatformType,
                        Object:      auth.MagistralaObject,
                })
                if err != nil </span><span class="cov1" title="1">{
                        return errors.Wrap(svcerr.ErrDeletePolicies, err)
                }</span>
                <span class="cov3" title="4">if !resp.Deleted </span><span class="cov2" title="2">{
                        return svcerr.ErrAuthorization
                }</span>
                <span class="cov2" title="2">return nil</span>
        }
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
